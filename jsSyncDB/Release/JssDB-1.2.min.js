var JssDB=function(n,t,i,r){function v(n,t,i){return this._temp=JssDB._dbObj,this._temp(n,"mainSync"),this.isDelete=i,this.objuuid=t,this}function y(n){var t=n.get("newTempSyncObjUUID"),i,r;for(t||(t=0),t=parseInt(t)+1,n.set("newTempSyncObjUUID",t),t=t+"",i=0,r=t.length;i<8-r;i++)t="0"+t;return"t"+t}function p(n,t,i){return this._temp=JssDB._dbObj,this._temp(y(n),"mainSync.Temp"),this.isDelete=i,this.objuuid=t,this}function e(n,t,i,r){function bt(n,t,i,r,u,f){var s,o,e;if(n.length){for(s=[],o=0;o<n.length;o++)e=c(n[o]),t&&(e.id=e.uuid),e.data&&delete e.data.uuid,e.data=JSON.stringify(e.data),s.push(e);jQuery.ajax({url:pt,dataType:"json",type:"POST",data:{code:tt,DBName:st,Data:JSON.stringify(s),uuid:w(),localUUID:dt(),uploadUUID:i,restore:t,localMaxId:r},success:function(n){n.status==1?(w()||w(n.uuid),u(n.data)):f(n.status,n.lastId)},error:function(){f(-9)}})}else u([])}function kt(n,t,i,r){jQuery.ajax({url:wt,dataType:"json",type:"Get",data:{code:tt,DBName:st,uuid:w(),beginId:n,isWait:d,take:t},success:function(n){var r,t;if(n.status==1)for(w()||w(n.uuid),r=n.data,t=0;t<r.length;t++)r[t]&&JSON.parse(r[t].data)&&(r[t].data=JSON.parse(r[t].data),r[t].data.uuid=r[t].objuuid);i(n)},error:function(){r(-9)}});d==0&&(d=1)}function lt(n,t,i){var u,e,r,o,s;if(!t._d().isContain(function(){return!h[this.table]})){f.dbOpObjs(n,t,i);return}for(u=[],e=[],r=0;r<t.length;r++)o=t[r],h[o.table]||(s=new p(f,o.uuid,n[r]),u.push(0),e.push(s)),u.push(n[r]),e.push(o);f.dbOpObjs(u,e,function(){it=!0;i&&i()})}function at(n){if(typeof n!="undefined")f.set("index",n);else return parseInt(f.get("index")||0)}function w(n){if(typeof n!="undefined")f.set("uuid",n);else return f.get("uuid")||""}function dt(){var n=f.get("localUUID");return n||(n=u(),f.set("localUUID",n)),n}function e(n){if(typeof n!="undefined")f.set("restoreSeek",n);else return parseInt(f.get("restoreSeek"))||-1}function rt(n){if(typeof n!="undefined")f.set("uploadUUID",n);else return f.get("uploadUUID")||""}function ut(n){if(typeof n!="undefined")f.set("uploadUUIDForRestore",n);else return f.get("uploadUUIDForRestore")||""}function g(n){function r(n){function r(t){for(var r=[],i=0;i<t.length;i++)r.push(t[i].objuuid);f.dbReadObjs(r,function(i){for(var r=0;r<t.length;r++)t[r].data=i[r];n(t)})}var i=null;ut()?(i=f.get("tempUploadData",1),r(i)):(ut(u()),f.dbRead("mainSync",[["uuid",">",e()]],0,ct,function(n){n.length==0&&(t=1);f.set("tempUploadData",n);r(n)}))}function i(){r(function(r){bt(r,1,ut(),e(),function(r){ut(null);t?(console.log("restore finish"),e(-1),y=0,n(1)):(e(r[r.length-1].id),i())},function(t){y=0;n(t)})})}if(n||(n=function(){}),y){n(-2);return}y=1;console.log("begin to restore :"+e());var t=0;i()}function ft(n){function i(n){function i(t){for(var r=[],i=0;i<t.length;i++)r.push(t[i].objuuid);f.dbReadObjs(r,function(i){for(var r=0;r<t.length;r++)t[r].data=i[r];n(t)})}var t=null;rt()?(t=f.get("tempUploadData",1),i(t)):(rt(u()),f.dbRead("mainSync.Temp",null,0,ct,function(n){f.set("tempUploadData",n);i(n)}))}function t(){i(function(i){bt(i,0,rt(),at(),function(i){var e,r,u;for(rt(null),e=f.get("localids",1)||{},r=0;r<i.length;r++)e["s"+i[r].id]=1;f.set("localids",e);var o=f.get("tempUploadData",1),s=[],h=[];for(r=0;r<i.length;r++)for(u=0;u<o.length;u++)if(o[u].objuuid==i[r].objuuid){s.push(1);h.push(o[u]);break}f.dbOpObjs(s,h,function(){f.dbRead("mainSync.Temp",function(i){i.length?t():(nt=0,it=!1,n(1))})})},function(t,i){nt=0;t==-2?(e(i),g(function(t){t==1?ft(n):n(t)})):n(t)})})}if(n||(n=function(){}),nt||y){n(-3);return}nt=1;t()}function et(n){function i(n,t){for(var i,u=[],e=[],r=0;r<n.data.length;r++)i=n.data[r],i.fromLocal||(i.isDelete?i.data&&i.data.uuid&&i.data.table&&(u.push(1),e.push(i.data)):(u.push(0),e.push(i.data))),u.push(0),e.push(new v(parseInt(i.id),i.objuuid,i.isDelete));for(r=0;n.delIds&&r<n.delIds.length;r++)u.push(1),e.push({uuid:n.delIds[r],table:"mainSync"});f.dbOpObjs(u,e,t)}function t(){var r=ct;kt(at()+1,r,function(r){var s,h,o,u;if(r.status==1)if(r.data.length>0){for(s=f.get("localids",1)||{},u=f.get("tempNewData",1)||[],h=0;h<r.data.length;h++)o=r.data[h],s["s"+o.id]==1?(o.fromLocal=!0,delete s["s"+o.id]):o.fromLocal=!1,u.push(o);f.set("localids",s);f.set("tempNewData",u);i(r,function(){if(at(r.data[r.data.length-1].id),r.data.length&&parseInt(r.data[r.data.length-1].id)<r.maxId)t();else{l=0;var i=f.get("tempNewData",1)||[];f.set("tempNewData");n(i.length?i:1)}})}else l=0,u=f.get("tempNewData",1)||[],f.set("tempNewData"),n(u.length?u:1);else r.status==-2?(l=0,e(r.maxId),g(function(t){n(t)})):(l=0,n(r.status))},function(t){l=0;n(t)})}l||y||(l=1,t())}function gt(n,t){var i=new Date;if(!vt||!((i.getTime()-vt.getTime())/1e3<t)){vt=i;ot();a=new WebSocket(ht);a.onopen=function(){console.log("WebSocket Connection open ...");k=!0;a.send(JSON.stringify({DBName:st,Code:tt}));et(n)};a.onmessage=function(t){k=!0;console.log("Received Message: "+t.data);t.data=="1"&&et(n)};a.onclose=function(){k=!1;console.log("Connection closed.")};a.onerror=function(n){console.log("Connection Error: "+n.data)};$(window).on("beforeunload",ot)}}function ni(){if(k){var n=new Date;(n.getTime()-yt.getTime())/1e3>=300&&(a.send("1"),yt=n)}}function ot(){k&&a.close();$(window).off("beforeunload",ot)}var st=t,f=JssDB.dbCode.get(t+"_"+n,r),tt=n,y,nt,l,yt;i&&i.charAt(i.length-1)!="/"&&(i+="/");var pt=i+"UploadDBObj",wt=i+"DownloadDBObj",ht=i.indexOf("http://")==0?"ws"+i.substring(4)+"ws":"wss"+i.substring(5)+"ws";var it=!1,ct=100,d=-1;this.opObj=lt;this.writeObj=function(n,t){var i,r;for(o(n)||(n=[n]),i=[],r=0;r<n.length;r++)i.push(0);lt(i,n,t)};this.writeObjWithoutSync=function(n,t){f.dbWriteObj(n,t)};this.deleteObjWithoutSync=function(n,t){f.dbDeleteObj(n,t)};this.deleteObj=function(n,t){var i,r;for(o(n)||(n=[n]),i=[],r=0;r<n.length;r++)i.push(1);lt(i,n,t)};this.readMainIndex=function(n,t,i,r){typeof t=="function"&&(r=t,t=0,i=0);f.dbRead("mainSync",[["uuid",">=",n]],t,i,function(n){for(var i=[],t=0;t<n.length;t++)n[t].isDelete||i.push(n[t].objuuid);f.dbReadObjs(i,function(t){for(var u,i=0;i<n.length;i++)if(!n[i].isDelete)for(u=0;u<t.length;u++)if(n[i].objuuid==t[u].uuid){n[i].data=t[u];t.splice(u,1);break}r(n)})})};this.dbReadObj=function(n,t){f.dbReadObj(n,t)};this.dbRead=function(n,t,i,r,u){f.dbRead(n,t,i,r,u)};y=0;nt=0;l=0;this.sync=function(n){function t(){ft(function(t){t==1?et(function(t){n(t)}):n(-9)})}d=-1;e()>=0?g(function(i){i==1?t():n(i)}):t()};var b=null,s=0,k=!1,a=null,vt=null;return yt=new Date,this.autoSync=function(n,t){(t||(t=30),b==null)&&(typeof WebSocket!="undefined"?b=window.setInterval(function(){if(k?ni():gt(n,t),s>0){s--;return}e()>=0?g(function(n){n==-9&&(s+=30)}):it&&ft(function(n){n==-9&&(s+=30)})},1e3):(d=0,b=window.setInterval(function(){if(s>0){s--;return}e()>=0?g(function(n){n==-9&&(s+=30)}):(it&&ft(function(n){n==-9&&(s+=30)}),et(function(t){t==-9&&(s+=30);n(t)}))},1e3)))},this.stopAutoSync=function(){b&&window.clearInterval(b);b=null;ot()},this.clear=function(n){f.clearDB(n)},this.getTable=function(n){return f.getTable(n)},this.setService=function(n,t){t&&t.charAt(t.length-1)!="/"&&(t+="/");pt=t+"UploadDBObj";wt=t+"DownloadDBObj";ht=t.indexOf("http://")==0?"ws"+t.substring(4)+"ws":"wss"+t.substring(5)+"ws";tt=n},this}var u=JssDB.tools.uuid,c=JssDB.tools.clone,w=JssDB.tools.arrayExtend,b=JssDB.tools._check,k=JssDB.tools._log,o=JssDB.tools.isArray,d=JssDB.tools.timepiece,g=JssDB.tools.ExecQueue,l=JssDB.dbModelIndex,s=JssDB.dbModelColumn,a=JssDB.dbModelIndexType,f=JssDB.dbModelTransformation,nt=JssDB.dbModelEvent,h=[];return s.mainSync=["isDelete","objuuid"],l.mainSync="uuid",a.mainSync="int",f.mainSync={viewModelToEntity:function(n){return n.isDelete+","+n.objuuid},entityToViewModel:function(n){var t=n.split(",");return{isDelete:parseInt(t[0]),objuuid:t[1]}}},s["mainSync.Temp"]=["isDelete","objuuid"],f["mainSync.Temp"]=f.mainSync,_MySyncDBs={},e.get=function(n,t,i,r){return _MySyncDBs[n]?_MySyncDBs[n]:(_MySyncDBs[n]=new e(t,n,i,r),_MySyncDBs[n])},e(n,t,i,r)},JssDB=JssDB||{};JssDB.dbModelIndex=JssDB.dbModelIndex||[];JssDB.dbModelColumn=JssDB.dbModelColumn||[];JssDB.dbModelIndexType=JssDB.dbModelIndexType||[];JssDB.dbModelTransformation=JssDB.dbModelTransformation||[];JssDB.dbModelEvent=JssDB.dbModelEvent||[];JssDB._dbObj=function(n,t){return this.uuid=n,this.table=t,this};JssDB=JssDB||{};JssDB.tools=function(){function i(){for(var s,u,e,h,f,i,r=[],o="0123456789abcdef",n=0;n<36;n++)r[n]=o.substr(Math.floor(Math.random()*16),1);for(r[14]="4",r[19]=o.substr(r[19]&3|8,1),r[8]=r[13]=r[18]=r[23]="",s=r.join(""),u=[],n=0;n<16;n++)e=n,n<4?e=3-n:n<6?e=9-n:n<8&&(e=13-n),h=parseInt(s.substr(e*2,2),16),u.push(h);for(f="",n=0;n<u.length;n+=3)i=u[n]+1,n+1<u.length&&(i*=u[n+1]+1),n+2<u.length&&(i*=u[n+2]+1),f+=t[i%64],i=parseInt(i/64),f+=t[i%64],n<15&&(i=parseInt(i/64),f+=t[i%64],i=parseInt(i/64),f+=t[i]);return f}function r(n){var t=JSON.stringify(n);return JSON.parse(t)}function n(n){return this.lst=n,this}function u(n,t){return n?console.log(t+" check:pass"):console.error(t+" check:failed"),n}function f(n){console&&console.log(n)}function e(n){return Object.prototype.toString.call(n)=="[object Array]"}function o(){var n=new Date;return this.reset=function(){n=new Date},this.check=function(){var t=new Date;return(t.getTime()-n.getTime())/1e3},this.show=function(n){var t=this.check();console.log("time spent: "+t+"s "+(n||""))},this}function s(){this.locked=0;var t=this,n=[];this.lock=function(){t.locked=1};this.push=function(t,i){n.push([t,i])};this.release=function(){if(t.locked=0,n.length){var i=n.shift();i[0].apply(this,i[1])}};this.fixCallBack=function(i){return function(){setTimeout(function(){if(t.locked=0,n.length){var i=n.shift();i[0].apply(this,i[1])}},0);i&&i.apply(this,arguments)}}}var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];return Array.prototype._d||(Array.prototype._d=function(){return new n(this)}),n.prototype.isContain||(n.prototype.isContain=function(n,t){var r,i;for(typeof n=="function"&&(t=n,n=null),r=this.lst,i=0;i<r.length;i++)if(t){if(t.apply(r[i],[r[i],n]))return!0}else if(r[i]==n)return!0;return!1}),n.prototype.remove||(n.prototype.remove=function(n,t){for(var r=this.lst,i=0;i<r.length;i++)if(t){if(t.apply(r[i],[r[i],n]))return r.splice(i,1),!0}else if(r[i]==n)return r.splice(i,1),!0;return!1}),n.prototype.filter||(n.prototype.filter=function(n){for(var r=[],i=this.lst,t=0;t<i.length;t++)n.apply(i[t],[i[t],t])&&r.push(i[t]);return r}),{uuid:i,clone:r,arrayExtend:n,_check:u,_log:f,isArray:e,timepiece:o,ExecQueue:s,toGlobal:function(t){t.uuid=i;t.clone=r;t.arrayExtend=n;t._check=u;t._log=f;t.isArray=e;t.timepiece=o;t.ExecQueue=s}}}();JssDB=JssDB||{};JssDB.dbCache=function(n){var f=JssDB.tools.uuid,e=JssDB.tools.clone,o=JssDB.tools.arrayExtend,s=JssDB.tools._check,h=JssDB.tools._log,c=JssDB.tools.isArray,l=JssDB.tools.timepiece,a=JssDB.tools.ExecQueue;this.limit=n;var t={},r={},i=[],u=i._d();this.length=0;this.exists=function(n){return n+="",!!r[n]};this.clear=function(){i=[];u=i._d();t={};r={};this.length=0};this.get=function(n){return(n=n+"",typeof t[n]=="undefined")?null:t[n]};this.set=function(n,f){var s,e,f;if(n=n+"",u.isContain(n)||i.push(n),typeof f=="undefined"&&(f=null),this.limit){var o=t[n],h=o?o.length:0,c=f?f.length:0;this.length+=c-h}if(t[n]=f,r[n]=1,this.limit&&this.length>this.limit)for(s=this.limit*.7;this.length>s;)e=i.shift(),delete r[e],f=t[e],f&&(this.length-=f.length),delete t[e]}};JssDB=JssDB||{};JssDB.dbBase=function(){function i(n,i){function c(n){return v+"."+n}function y(n,t){var i;return e.exists(n)?i=e.get(n):(i=localStorage.getItem(c(n)),e.set(n,i)),t&&i&&(i=JSON.parse(i)),i}function p(n,t){typeof t!="undefined"?(typeof t=="object"&&t!==null?t=JSON.stringify(t):t!==null&&(t=t+""),e.set(n,t),t===null?localStorage.removeItem(c(n)):localStorage.setItem(c(n),t)):(e.set(n),localStorage.removeItem(c(n)))}function w(n){for(var r,i=[],t=0,u=localStorage.length;t<u;t++)r=localStorage.key(t),r.indexOf(v+".")==0&&i.push(r);for(t=0;t<i.length;t++)localStorage.removeItem(i[t]);e.clear();s.clear();f.clear(n)}function b(n,t,i){function a(n){for(var t=0;t<n.length;t++)e[l[t]]=n[t];return c?i(e):i(e[0])}var c=r(n),u,o;c||(n=[n]);var e=[],h=[],l=[];for(u=0;u<n.length;u++)s.exists(n[u])?(o=s.get(n[u]),o&&t&&(o=JSON.parse(o)),e.push(o)):(h.push(n[u]),l.push(u),e.push(null));h.length?f.getVals(h,t,a):setTimeout(function(){a([])},0)}function k(n,t,i){var u;r(n)?u=n:(u=[],typeof t!="function"?a(n,t,u):a(n,u));typeof i=="undefined"&&(i=t);i||(i=function(){});f.exec(u,s,i)}function a(n,t,i){var r=!1;typeof i=="undefined"&&(i=t,r=!0);f.delCmd(n,i);r||(typeof t=="object"?t=JSON.stringify(t):t&&(t=t+""),f.addCmd(n,t,i))}var v=n,f,e=new u,s=new u(10485760),l,h,o;if(i||(i=y("dbtype")),i&&JssDB.dbBase[i]&&JssDB.dbBase[i].isSupport()&&(f=new JssDB.dbBase[i](n),t("using "+JssDB.dbBase[i].dbname)),!f){l=0;for(o in JssDB.dbBase)typeof JssDB.dbBase[o].isSupport=="function"&&JssDB.dbBase[o].isSupport()&&JssDB.dbBase[o].priority>l&&(l=JssDB.dbBase[o].priority,h=JssDB.dbBase[o]);if(h)f=new h(n),t("using "+h.dbname);else{t("No support any local database");return}}this.get=y;this.set=p;this.setDB=k;this.setDBcmd=a;this.getDB=b;this.clear=w}var f=JssDB.tools.uuid,e=JssDB.tools.clone,o=JssDB.tools.arrayExtend,s=JssDB.tools._check,t=JssDB.tools._log,r=JssDB.tools.isArray,h=JssDB.tools.timepiece,c=JssDB.tools.ExecQueue,u=JssDB.dbCache,n=[];return i.get=function(t,r){return n[t]?n[t]:(n[t]=new i(t,r),n[t])},i}();JssDB=JssDB||{};JssDB.dbBase=JssDB.dbBase||{};JssDB.dbBase.Sqlite=function(){function n(n){function r(){if(i[t])return i[t];var n=openDatabase(t,"1.0",t,10485760,function(){});return n.transaction(function(n){n.executeSql(u,[],function(){},function(){})}),i[t]=n,n}function f(n,t){t.push({sql:"delete from t_main where pkey=?;",para:[""+n]})}function e(n,t,i){i.push({sql:"insert into t_main(pkey,pvalue) values(?,?);",para:[""+n,t]})}function o(n,t,i){var u=r();u.transaction(function(r){for(var u,f=0;f<n.length;f++)u=n[f],t.set(u.para[0],u.para[1]),f!=n.length-1?r.executeSql(u.sql,u.para,function(){},function(n,t){console.log(t)}):r.executeSql(u.sql,u.para,i,function(n,t){console.log(t)})})}function s(n,t,i){function e(){for(var r="",s=[],h=0;h<100&&u<n.length;h++,u++)h!=0&&(r+=","),r+="'"+n[u]+"'",s.push(n[u]);o.transaction(function(o){o.executeSql("select pvalue val,pkey key from t_main where pkey in ("+r+");",[],function(r,o){for(var l,a,c=[],h=0;h<o.rows.length;h++)c.push(o.rows.item(h));for(l=0;l<s.length;l++){for(a=null,h=0;h<c.length;h++)if(c[h].key==s[l]){a=t?JSON.parse(c[h].val):c[h].val;c.splice(h,1);break}f.push(a)}u==n.length?i(f):e()},function(n,t){console.log(t)})})}var o=r(),f=[],u=0;e()}function h(n){var t=r();t.transaction(function(t){t.executeSql("drop table t_main;",[],function(){},function(n,t){console.log(t)});t.executeSql(u,[],n,function(n,t){console.log(t)})})}var t=n,u="create table if not exists t_main(pkey varchar(100) primary key,pvalue TEXT);",i={};this.delCmd=f;this.addCmd=e;this.exec=o;this.getVals=s;this.clear=h}var t=JssDB.tools.uuid,i=JssDB.tools.clone,r=JssDB.tools.arrayExtend,u=JssDB.tools._check,f=JssDB.tools._log,e=JssDB.tools.isArray,o=JssDB.tools.timepiece,s=JssDB.tools.ExecQueue;return n.isSupport=function(){var t=typeof openDatabase!="undefined",i;if(t)try{i=new n("_isSupportSqlite")}catch(r){t=!1}return t},n.dbname="Sqlite",n.priority=2,n}();JssDB=JssDB||{};JssDB.dbBase=JssDB.dbBase||{};JssDB.dbBase.LocalStorage=function(){function n(n){function t(n){return r+"."+n}function u(n,i){var r=localStorage.getItem(t(n));return i&&r&&(r=JSON.parse(r)),r}function i(n,i){typeof i!="string"&&(i=JSON.stringify(i));typeof i!="undefined"?localStorage.setItem(t(n),i):localStorage.removeItem(t(n))}var r=n;this.delCmd=function(n,t){t.push({ac:"del",key:n})};this.addCmd=function(n,t,i){i.push({ac:"set",key:n,val:t})};this.exec=function(n,t,r){for(var u,f=0;f<n.length;f++)u=n[f],u.ac=="del"?i(u.key):i(u.key,u.val),t.set(u.key,u.val);r()};this.getVals=function(n,t,i){for(var e,f=[],r=0;r<n.length;r++)e=u(n[r],t),f.push(e);i(f)};this.clear=function(n){n&&n()}}var t=JssDB.tools.uuid,i=JssDB.tools.clone,r=JssDB.tools.arrayExtend,u=JssDB.tools._check,f=JssDB.tools._log,e=JssDB.tools.isArray,o=JssDB.tools.timepiece,s=JssDB.tools.ExecQueue;return n.dbname="LocalStorage",n.priority=1,n.isSupport=function(){return typeof localStorage!="undefined"},n}();JssDB=JssDB||{};JssDB.dbBase=JssDB.dbBase||{};JssDB.dbBase.IndexedDB=function(){function n(n){function u(n){if(r){n(r);return}var t=window.indexedDB.open(f,1);t.onerror=function(n){console.log(n.currentTarget.error.message)};t.onsuccess=function(t){r=t.target.result;n(r)};t.onupgradeneeded=function(n){var t=n.target.result;t.objectStoreNames.contains(i)||t.createObjectStore(i,{keyPath:"key"})}}var f=n,i="t_main",r=null;this.delCmd=function(n,t){t.push({ac:"del",key:n})};this.addCmd=function(n,t,i){i.push({ac:"set",key:n,val:t})};this.exec=function(n,t,f){u(function(){for(var e,s=r.transaction(i,"readwrite"),o=s.objectStore(i),u=0;u<n.length;u++)t.set(n[u].key,n[u].val),n[u].ac=="del"?e=o.delete(n[u].key):(delete n[u].ac,e=o.put(n[u])),e.onerror=function(n){console.log(n)},u==n.length-1&&(e.onsuccess=function(){f()})})};this.getVals=function(n,f,e){if(!n.length){e([]);return}var o=t(n);u(function(){function o(){for(var a,l,c,h=[],s=0;s<100&&u<n.length;s++,u++)h.push(n[u]);for(a=r.transaction(i,"readwrite"),l=a.objectStore(i),s=0;s<h.length;s++)s<h.length-1?(c=l.get(h[s]),c.onsuccess=function(n){var i=n.target.result;i?t.push(f?JSON.parse(i.val):i.val):t.push(null)}):(c=l.get(h[s]),c.onsuccess=function(i){var r=i.target.result;r?t.push(f?JSON.parse(r.val):r.val):t.push(null);u==n.length?e(t):o()})}var t=[],u=0;o()})};this.clear=function(n){u(function(){var t=r.transaction(i,"readwrite"),u=t.objectStore(i),f=u.clear();f.onsuccess=function(){n&&n()}})}}var i=JssDB.tools.uuid,t=JssDB.tools.clone,r=JssDB.tools.arrayExtend,u=JssDB.tools._check,f=JssDB.tools._log,e=JssDB.tools.isArray,o=JssDB.tools.timepiece,s=JssDB.tools.ExecQueue;return n.dbname="IndexedDB",n.priority=3,n.isSupport=function(){var t=typeof indexedDB!="undefined",i;if(t)try{i=new n("_isSupportIndexedDB")}catch(r){t=!1}return t},n}();JssDB=JssDB||{};JssDB.dbCode=JssDB.dbCode||function(){function c(n,t){return this.dbRead=function(i,r,u,f){n.dbRead(t,i,r,u,f)},this}function e(r,e){function ct(n){l.clear(n)}function ut(n){var i=l.get("indexidentityRe",1)||[],t;if(n){i.push(n);l.set("indexidentityRe",i);return}return i.length?(t=i[0],i.splice(0,1),l.set("indexidentityRe",i),t):(t=l.get("indexidentity"),t||(t=1),t=parseInt(t),l.set("indexidentity",t+1),t)}function ft(n){var t=l.get("tableName."+n);return t?parseInt(t):(t=l.get("tableIndexIdentity"),t||(t=1),t=parseInt(t),l.set("tableIndexIdentity",t+1),l.set("tableName."+n,t),l.set("tableIndex."+t,n),t)}function et(n){return l.get("tableIndex."+n)}function ot(n){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return n<52?t.charAt(n):t.charAt(n/52)+t.charAt(n%52)}function lt(n){var r,t,u;if(f[n.table])return ft(n.table)+","+f[n.table].viewModelToEntity(n);if(n.uuid&&n.table){for(r={},r.b=ft(n.table),t=0;t<i[n.table].length;t++)u=i[n.table][t],r[ot(t+2)]=n[u];return r}return null}function p(n,t){var e,o,h,s,r,u,c;if(!n)return null;if(e=n.indexOf(","),e>0&&(o=n.substr(0,e),h=Number(o),!isNaN(h)))return s=et(o),r=f[s].entityToViewModel(n.substr(e+1)),r.uuid=t,r.table=s,r;if(n=JSON.parse(n),n.b){for(r={uuid:t,table:et(n.b)},u=0;u<i[r.table].length;u++)c=i[r.table][u],r[c]=n[ot(u+2)];return r}return null}function st(n){return!!(n&&n.uuid&&n.table&&i[n.table])}function b(n,t,i){if(!n.length&&!t.length){i();return}if(!n.length||!t.length||n.length!=t.length){console&&console.error("Invalid data");i(-1);return}y=y.concat(n);w=w.concat(t);setTimeout(function(){if(!y.length){i&&i();return}at(y,w,i);y=[];w=[]},0)}function at(n,i,r){var e,f,u,h,s;if(r||(r=function(){}),!n.length&&!i.length){r();return}if(!n.length||!i.length||n.length!=i.length){console&&console.error("Invalid data");r(-1);return}for(u=0;u<i.length;u++)if(!st(i[u])){console&&console.error("Invalid data");console.error(i[u]);r(-1);return}for(e=o(n),f=o(i),u=0;u<f.length-1;u++){for(h=!1,s=u+1;s<f.length;s++)if(f[u].uuid==f[s].uuid){h=!0;break}h&&(f.splice(u,1),e.splice(u,1),u--)}e&&e.length?a.locked?a.push(b,[e,f,r]):(a.lock(),r=a.fixCallBack(r),ni(e,f,function(n){for(var u,i,a,o=[],c=[],h=[],s=0;s<f.length;s++)u=e[s],i=f[s],u?l.setDBcmd(i.uuid,n):(a=lt(i),l.setDBcmd(i.uuid,a,n)),t[i.table]&&(t[i.table].onDelete&&u==1||t[i.table].onSave&&u!=1)&&(o.push(i),c.push(i.uuid),h.push(u));o.length>0?nt(c,function(i){for(var u=0;u<o.length;u++){var e=i[u],s=o[u],f=s.table;if(h[u]==1&&e){if(t[f].onDelete)t[f].onDelete(e)}else if(h[u]!=1&&t[f].onSave)t[f].onSave(e,s)}l.setDB(n,r)}):l.setDB(n,r)})):r()}function vt(n,t){var i,r;for(u(n)||(n=[n]),i=[],r=0;r<n.length;r++)i.push(0);b(i,n,t)}function yt(n,t){var i,r;for(u(n)||(n=[n]),i=[],r=0;r<n.length;r++)i.push(1);b(i,n,t)}function pt(n,t){l.getDB(n,0,function(i){var r;r=i?p(i,n):{};t(r)})}function nt(n,t){l.getDB(n,0,function(i){for(var f,e,u=[],r=0;r<i.length;r++)f=i[r],e=p(f,n[r]),u.push(e);t(u)})}function wt(t,i,r){var u,o,e,f;for(r||(r=[]),u=0;u<t.length;u++)if(o=t[u].r,o||(t[u].r="r"+ut(),o=t[u].r),t[u].l){if(t[u].d){if(n[i]&&n[i]!="uuid"){for(e="",f=0;f<t[u].d.length;f++)f!=0&&(e+=","),e+=t[u].d[f].u+","+t[u].d[f].i;l.setDBcmd(o,e,r)}else{for(e="",f=0;f<t[u].d.length;f++)f!=0&&(e+=","),e+=t[u].d[f].u;l.setDBcmd(o,e,r)}t[u].d=null;delete t[u].d}}else ut(parseInt(o.substr(1))),l.setDBcmd(o,r),t.splice(u,1),u--;return l.setDBcmd("table."+i,t,r),r}function k(n,t,i){for(var u=!1,r=0;r<n.length;r++)if(typeof i!="undefined"){if(i>=n[r]&&t<=n[r]){u=!0;break}}else if(t==n[r]){u=!0;break}return u}function bt(n,t,i,r,u,f,e){var o;if(k(n,t,i))return!0;if(f){if(typeof t!="undefined")for(o=0;o<n.length;o++)if(t>n[o])return!0}else if(typeof i!="undefined"&&typeof r!="undefined")for(o=0;o<n.length;o++)if(i<n[o]&&n[o]<r)return!0;if(e){if(typeof i!="undefined")for(o=0;o<n.length;o++)if(i<n[o])return!0}else if(typeof t!="undefined"&&typeof u!="undefined")for(o=0;o<n.length;o++)if(t>n[o]&&n[o]>u)return!0;return!1}function tt(t,i,r,u,f){typeof i=="function"&&(u=i,i=null,r=null);l.getDB("table."+t,1,function(e){var v,a,o,h,c,y,p;for(e=e||[],v=[],a=[],o=0;o<e.length;o++)h=e[o].s,c=e[o].e,f?(y=o<e.length-1?e[o+1].s:e.undefined,p=o>0?e[o-1].e:e.undefined,(!r||bt(r,h,c,y,p,o==0,o==e.length-1))&&(a.push(e[o]),v.push(e[o].r))):(i=="sw"&&typeof h=="string"&&typeof c=="string"&&(h=h.substr(0,r.length),c=c.substr(0,r.length)),(!r||i=="<"&&h<r||i=="<="&&h<=r||i==">"&&c>r||i==">="&&c>=r||i=="="&&c>=r&&h<=r||i=="bt"&&c>=r[0]&&h<=r[1]||i=="in"&&k(r,h,c)||i=="sw"&&c>=r&&h<=r)&&(a.push(e[o]),v.push(e[o].r)));l.getDB(v,0,function(i){for(var c,f,o,r,h=0;h<a.length;h++)if(c=i[h],n[t]&&n[t]!="uuid"){for(f=c.split(","),o=[],r=0;r<f.length;r+=2)s[t]=="int"?o.push({u:f[r],i:parseInt(f[r+1])}):o.push({u:f[r],i:f[r+1]});a[h].d=o}else{for(f=c.split(","),o=[],r=0;r<f.length;r++)s[t]=="int"?o.push({u:parseInt(f[r])}):o.push({u:f[r]});a[h].d=o}u(e)})})}function v(n,t){var i=it(n);return i==t?0:i<t?-1:1}function it(t){var i=n[t.table];return i||(i="uuid"),t[i]}function d(n){var t={u:n.uuid};return kt(n,t),t}function kt(t,i){var r=n[t.table];r&&r!="uuid"&&(i.i=t[r])}function g(n){var t=n.d;n.l=t.length;n.s=typeof t[0].i!="undefined"?t[0].i:t[0].u;n.e=typeof t[t.length-1].i!="undefined"?t[t.length-1].i:t[t.length-1].u}function dt(n,t){for(var e,r,c,l,o,s,h=0,u=null,a=0,f=n._d().filter(function(){return this.ioi=a++,!!this.d}),i=0;i<f.length;i++)if(e=!1,i==0&&v(t,f[i].s)<0?e=!0:i==f.length-1?e=!0:v(t,f[i].s)>=0&&v(t,f[i+1].s)<0&&(e=!0),e){u=f[i];h=u.ioi;break}if(u){if(r=u.d,r.length)for(i=0;i<r.length;i++){if(i!=0&&(c=typeof r[i-1].i!="undefined"?r[i-1].i:r[i-1].u),l=typeof r[i].i!="undefined"?r[i].i:r[i].u,(i==0||v(t,c)>=0)&&v(t,l)<0){r.splice(i,0,d(t));break}if(i==r.length-1){r.push(d(t));break}}else r.push(d(t));u.l>rt?(o=parseInt(rt/2),u.d=r.slice(o),g(u),s={d:r.slice(0,o)},g(s),n.splice(h,0,s)):g(u)}else u={d:[d(t)]},g(u),n.push(u);for(i=0;i<n.length;i++)delete n[i].ioi;return n}function gt(n,t){var u=n._d().filter(function(n){return v(t,n.e)<=0&&v(t,n.s)>=0}),r,i;return u=u._d().filter(function(n){return n.d._d().remove(t.uuid,function(n,t){return n.u==t})}),u.length&&(r=u[0],r.l--,i=r.d,i.length&&(r.s=typeof i[0].i!="undefined"?i[0].i:i[0].u,r.e=typeof i[i.length-1].i!="undefined"?i[i.length-1].i:i[i.length-1].u)),n}function ni(n,t,i){for(var u,e,r=[],o=[],f=0;f<t.length;f++)o.push(t[f].uuid),u=r._d().filter(function(n){return n.table==t[f].table}),u.length?u=u[0]:(u={table:t[f].table,indexs:[]},r.push(u)),e=it(t[f]),u.indexs._d().isContain(e)||u.indexs.push(e);nt(o,function(u){function c(u){var s=r._d().filter(function(n){return!e[n.table]}),l,u,h,f;if(e[s[0].table]=u,s.length>1)setTimeout(function(){tt(s[1].table,"in",s[1].indexs,c,1)},0);else{for(f=0;f<t.length;f++)l=n[f],u=e[t[f].table],o[t[f].uuid]&&(u=gt(u,o[t[f].uuid])),l||(u=dt(u,t[f])),e[t[f].table]=u;for(h=[],f=0;f<r.length;f++)wt(e[r[f].table],r[f].table,h);i(h)}}for(var s,h,e,o={},f=0;f<u.length;f++)u[f]&&(s=r._d().filter(function(n){return n.table==u[f].table})[0],h=it(u[f]),s.indexs._d().isContain(h)||s.indexs.push(h),o[u[f].uuid]=u[f]);e={};tt(r[0].table,"in",r[0].indexs,c,1)})}function ht(t,i,r,f,e){var s,o,h;if(typeof i=="function"?(e=i,i=[],r=0,f=0):typeof r=="function"&&(e=r,r=0,f=0),a.locked){a.push(ht,[t,i,r,f,e]);return}for(a.lock(),e=a.fixCallBack(e),i||(i=[]),i.length>0&&!u(i[0])&&(i=[i]),s=null,o=null,h=0;h<i.length;h++)if(i[h][0]==n[t]&&i[h][1]!="con"&&i[h][1]!="em"&&i[h][1]!="ne"){s=i[h][1];o=i[h][2];break}tt(t,s,o,function(n){var c,u,h,t,v,a;if(n=n._d().filter(function(n){return!!n.d}),o&&i.length==1||i.length==0){for(c=[],a=0,u=0;u<n.length;u++){for(h=0;h<n[u].d.length;h++)if(t=typeof n[u].d[h].i!="undefined"?n[u].d[h].i:n[u].d[h].u,(!o||s=="<"&&t<o||s=="<="&&t<=o||s==">"&&t>o||s==">="&&t>=o||s=="="&&t==o||s=="bt"&&t>=o[0]&&t<o[1]||s=="in"&&k(o,t)||s=="sw"&&t.indexOf(o)==0)&&(a++,a>r&&c.push(n[u].d[h].u),f&&c.length>=f))break;if(f&&c.length>=f)break}l.getDB(c,0,function(n){for(var i=[],t=0;t<n.length;t++)i.push(p(n[t],c[t]));e(i)})}else{v=[];a=0;function y(){var o,t,u;if(n.length){for(o=n.shift(),t=[],u=0;u<o.d.length;u++)t.push(o.d[u].u);l.getDB(t,0,function(n){for(var l,w,h,c=0;c<n.length;c++){for(l=p(n[c],t[c]),w=!0,h=0;h<i.length;h++){var b=i[h][0],o=i[h][1],s=i[h][2],u=l[b];if((o!="<"||!(u<s))&&(o!="<="||!(u<=s))&&(o!=">"||!(u>s))&&(o!=">="||!(u>=s))&&(o!="="||u!=s)&&(o!="bt"||!(u>=s[0])||!(u<s[1]))&&(o!="in"||!k(s,u))&&(o!="con"||typeof u!="string"||u.indexOf(s)==-1)&&(o!="sw"||u.indexOf(s)!=0)&&(o!="em"||u!==null&&u!=="")&&(o!="ne"||u===null||u==="")){w=!1;break}}if(w&&(a++,a>r&&v.push(l),f&&v.length>=f))break}f&&v.length>=f?e(v):setTimeout(y,0)})}else e(v)}y()}})}var ti=r,rt=200,l=JssDB.dbBase.get(r,e),a=new h,y=[],w=[];return this.dbOpObjs=b,this.dbWriteObj=vt,this.dbDeleteObj=yt,this.dbRead=ht,this.dbReadObj=pt,this.dbReadObjs=nt,this.clearDB=ct,this.checkFormat=st,this.get=function(n,t){return l.get(n,t)},this.set=function(n,t){return l.set(n,t)},this.getTable=function(n){return new c(this,n)},this}var l=JssDB.tools.uuid,o=JssDB.tools.clone,a=JssDB.tools.arrayExtend,v=JssDB.tools._check,y=JssDB.tools._log,u=JssDB.tools.isArray,p=JssDB.tools.timepiece,h=JssDB.tools.ExecQueue,n=JssDB.dbModelIndex,i=JssDB.dbModelColumn,s=JssDB.dbModelIndexType,f=JssDB.dbModelTransformation,t=JssDB.dbModelEvent,r={};return e.get=function(n,t){return r[n]?r[n]:(r[n]=new e(n,t),r[n])},e}();